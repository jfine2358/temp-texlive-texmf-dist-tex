%%
%% This is file `l3coffins.sty',
%% generated with the docstrip utility.
%%
%% The original source files were:
%%
%% l3coffins.dtx  (with options: `package')
%% 
%% EXPERIMENTAL CODE
%% 
%% Do not distribute this file without also distributing the
%% source files specified above.
%% 
%% Do not distribute a modified version of this file.
%% 
%% File: l3coffins.dtx Copyright(C) 2010-2012 The LaTeX3 Project
%%
%% It may be distributed and/or modified under the conditions of the
%% LaTeX Project Public License (LPPL), either version 1.3c of this
%% license or (at your option) any later version.  The latest version
%% of this license is in the file
%%
%%    http://www.latex-project.org/lppl.txt
%%
%% This file is part of the "l3kernel bundle" (The Work in LPPL)
%% and all files in that bundle must be distributed together.
%%
%% The released version of this bundle is available from CTAN.
%%
%% -----------------------------------------------------------------------
%%
%% The development version of the bundle can be found at
%%
%%    http://www.latex-project.org/svnroot/experimental/trunk/
%%
%% for those people who are interested.
%%
%%%%%%%%%%%
%% NOTE: %%
%%%%%%%%%%%
%%
%%   Snapshots taken from the repository represent work in progress and may
%%   not work or may contain conflicting material!  We therefore ask
%%   people _not_ to put them into distributions, archives, etc. without
%%   prior consultation with the LaTeX Project Team.
%%
%% -----------------------------------------------------------------------
%%
\RequirePackage{l3names}
\GetIdInfo$Id: l3coffins.dtx 3482 2012-03-03 18:48:06Z bruno $
  {L3 Experimental coffin code layer}
\ProvidesExplPackage
  {\ExplFileName}{\ExplFileDate}{\ExplFileVersion}{\ExplFileDescription}
\package_check_loaded_expl:
\box_new:N \l_coffin_internal_box
\dim_new:N \l_coffin_internal_dim
\fp_new:N  \l_coffin_internal_fp
\tl_new:N  \l_coffin_internal_tl
\prop_new:N \c_coffin_corners_prop
\prop_put:Nnn \c_coffin_corners_prop { tl } { { 0 pt } { 0 pt } }
\prop_put:Nnn \c_coffin_corners_prop { tr } { { 0 pt } { 0 pt } }
\prop_put:Nnn \c_coffin_corners_prop { bl } { { 0 pt } { 0 pt } }
\prop_put:Nnn \c_coffin_corners_prop { br } { { 0 pt } { 0 pt } }
\prop_new:N \c_coffin_poles_prop
\tl_set:Nn \l_coffin_internal_tl { { 0 pt } { 0 pt } { 0 pt } { 1000 pt } }
\prop_put:Nno \c_coffin_poles_prop { l }  { \l_coffin_internal_tl }
\prop_put:Nno \c_coffin_poles_prop { hc } { \l_coffin_internal_tl }
\prop_put:Nno \c_coffin_poles_prop { r }  { \l_coffin_internal_tl }
\tl_set:Nn \l_coffin_internal_tl { { 0 pt } { 0 pt } { 1000 pt } { 0 pt } }
\prop_put:Nno \c_coffin_poles_prop { b }  { \l_coffin_internal_tl }
\prop_put:Nno \c_coffin_poles_prop { vc } { \l_coffin_internal_tl }
\prop_put:Nno \c_coffin_poles_prop { t }  { \l_coffin_internal_tl }
\prop_put:Nno \c_coffin_poles_prop { B }  { \l_coffin_internal_tl }
\prop_put:Nno \c_coffin_poles_prop { H }  { \l_coffin_internal_tl }
\prop_put:Nno \c_coffin_poles_prop { T }  { \l_coffin_internal_tl }
\fp_new:N \l_coffin_calc_a_fp
\fp_new:N \l_coffin_calc_b_fp
\fp_new:N \l_coffin_calc_c_fp
\fp_new:N \l_coffin_calc_d_fp
\fp_new:N \l_coffin_calc_result_fp
\bool_new:N \l_coffin_error_bool
\dim_new:N \l_coffin_offset_x_dim
\dim_new:N \l_coffin_offset_y_dim
\tl_new:N \l_coffin_pole_a_tl
\tl_new:N \l_coffin_pole_b_tl
\fp_new:N \l_coffin_sin_fp
\fp_new:N \l_coffin_cos_fp
\dim_new:N \l_coffin_x_dim
\dim_new:N \l_coffin_y_dim
\dim_new:N \l_coffin_x_prime_dim
\dim_new:N \l_coffin_y_prime_dim
\fp_new:N \l_coffin_x_fp
\fp_new:N \l_coffin_y_fp
\fp_new:N \l_coffin_x_prime_fp
\fp_new:N \l_coffin_y_prime_fp
\dim_new:N \l_coffin_Depth_dim
\dim_new:N \l_coffin_Height_dim
\dim_new:N \l_coffin_TotalHeight_dim
\dim_new:N \l_coffin_Width_dim
\cs_new_nopar:Npn \coffin_saved_Depth:       { }
\cs_new_nopar:Npn \coffin_saved_Height:      { }
\cs_new_nopar:Npn \coffin_saved_TotalHeight: { }
\cs_new_nopar:Npn \coffin_saved_Width:       { }
\cs_new_protected:Npn \coffin_if_exist:NT #1#2
  {
    \cs_if_exist:NTF #1
      {
        \cs_if_exist:cTF { l_coffin_poles_ \int_value:w #1 _prop }
          { #2 }
          {
            \msg_kernel_error:nnx { coffins } { unknown-coffin }
              { \token_to_str:N #1 }
          }
      }
      {
        \msg_kernel_error:nnx { coffins } { unknown-coffin }
          { \token_to_str:N #1 }
      }
  }
\cs_new_protected:Npn \coffin_clear:N #1
  {
    \coffin_if_exist:NT #1
      {
        \box_clear:N #1
        \coffin_reset_structure:N #1
      }
  }
\cs_generate_variant:Nn \coffin_clear:N { c }
\cs_new_protected:Npn \coffin_new:N #1
  {
    \box_new:N #1
    \prop_clear_new:c { l_coffin_corners_ \int_value:w #1 _prop }
    \prop_clear_new:c { l_coffin_poles_   \int_value:w #1 _prop }
    \prop_gset_eq:cN { l_coffin_corners_ \int_value:w #1 _prop }
      \c_coffin_corners_prop
    \prop_gset_eq:cN { l_coffin_poles_ \int_value:w #1 _prop }
      \c_coffin_poles_prop
  }
\cs_generate_variant:Nn \coffin_new:N { c }
\cs_new_protected:Npn \hcoffin_set:Nn #1#2
  {
    \coffin_if_exist:NT #1
      {
        \hbox_set:Nn #1
          {
            \color_group_begin:
              \color_ensure_current:
              #2
            \color_group_end:
          }
        \coffin_reset_structure:N #1
        \coffin_update_poles:N #1
        \coffin_update_corners:N #1
      }
  }
\cs_generate_variant:Nn \hcoffin_set:Nn { c }
\cs_new_protected:Npn \vcoffin_set:Nnn #1#2#3
  {
    \coffin_if_exist:NT #1
      {
        \vbox_set:Nn #1
          {
            \dim_set:Nn \tex_hsize:D {#2}
            \color_group_begin:
              \color_ensure_current:
              #3
            \color_group_end:
          }
        \coffin_reset_structure:N #1
        \coffin_update_poles:N #1
        \coffin_update_corners:N #1
        \vbox_set_top:Nn \l_coffin_internal_box { \vbox_unpack:N #1 }
        \coffin_set_pole:Nnx #1 { T }
          {
            { 0 pt }
            { \dim_eval:n { \box_ht:N #1 - \box_ht:N \l_coffin_internal_box } }
            { 1000 pt }
            { 0 pt }
          }
        \box_clear:N \l_coffin_internal_box
      }
  }
\cs_generate_variant:Nn \vcoffin_set:Nnn { c }
\cs_new_protected:Npn \hcoffin_set:Nw #1
  {
    \coffin_if_exist:NT #1
      {
        \hbox_set:Nw #1 \color_group_begin: \color_ensure_current:
          \cs_set_protected_nopar:Npn \hcoffin_set_end:
            {
                \color_group_end:
              \hbox_set_end:
              \coffin_reset_structure:N #1
              \coffin_update_poles:N #1
              \coffin_update_corners:N #1
            }
      }
  }
\cs_new_protected_nopar:Npn \hcoffin_set_end: { }
\cs_generate_variant:Nn \hcoffin_set:Nw { c }
\cs_new_protected:Npn \vcoffin_set:Nnw #1#2
  {
    \coffin_if_exist:NT #1
      {
        \vbox_set:Nw #1
          \dim_set:Nn \tex_hsize:D {#2}
          \color_group_begin: \color_ensure_current:
          \cs_set_protected:Npn \vcoffin_set_end:
            {
                \color_group_end:
              \vbox_set_end:
              \coffin_reset_structure:N #1
              \coffin_update_poles:N #1
              \coffin_update_corners:N #1
              \vbox_set_top:Nn \l_coffin_internal_box { \vbox_unpack:N #1 }
              \coffin_set_pole:Nnx #1 { T }
                {
                  { 0 pt }
                  {
                    \dim_eval:n { \box_ht:N #1 - \box_ht:N \l_coffin_internal_box }
                  }
                  { 1000 pt }
                  { 0 pt }
                }
              \box_clear:N \l_coffin_internal_box
            }
      }
  }
\cs_new_protected_nopar:Npn \vcoffin_set_end: { }
\cs_generate_variant:Nn \vcoffin_set:Nnw { c }
\cs_new_protected:Npn \coffin_set_eq:NN #1#2
  {
    \coffin_if_exist:NT #1
      {
        \box_set_eq:NN #1 #2
        \coffin_set_eq_structure:NN #1 #2
      }
  }
\cs_generate_variant:Nn \coffin_set_eq:NN { c , Nc , cc }
\coffin_new:N \c_empty_coffin
\hbox_set:Nn  \c_empty_coffin { }
\coffin_new:N \l_coffin_aligned_coffin
\coffin_new:N \l_coffin_aligned_internal_coffin
\cs_new_eq:NN \coffin_dp:N \box_dp:N
\cs_new_eq:NN \coffin_dp:c \box_dp:c
\cs_new_eq:NN \coffin_ht:N \box_ht:N
\cs_new_eq:NN \coffin_ht:c \box_ht:c
\cs_new_eq:NN \coffin_wd:N \box_wd:N
\cs_new_eq:NN \coffin_wd:c \box_wd:c
\cs_new_protected:Npn \coffin_get_pole:NnN #1#2#3
  {
    \prop_get:cnNF
      { l_coffin_poles_ \int_value:w #1 _prop } {#2} #3
      {
        \msg_kernel_error:nnxx { coffins } { unknown-coffin-pole }
          {#2} { \token_to_str:N #1 }
        \tl_set:Nn #3 { { 0 pt } { 0 pt } { 0 pt } { 0 pt } }
      }
  }
\cs_new_protected:Npn \coffin_reset_structure:N #1
  {
    \prop_set_eq:cN { l_coffin_corners_ \int_value:w #1 _prop }
      \c_coffin_corners_prop
    \prop_set_eq:cN { l_coffin_poles_ \int_value:w #1 _prop }
      \c_coffin_poles_prop
  }
\cs_new_protected:Npn \coffin_set_eq_structure:NN #1#2
  {
    \prop_set_eq:cc { l_coffin_corners_ \int_value:w #1 _prop }
      { l_coffin_corners_ \int_value:w #2 _prop }
    \prop_set_eq:cc { l_coffin_poles_ \int_value:w #1 _prop }
      { l_coffin_poles_ \int_value:w #2 _prop }
  }
\cs_new_protected:Npn \coffin_gset_eq_structure:NN #1#2
  {
    \prop_gset_eq:cc { l_coffin_corners_ \int_value:w #1 _prop }
      { l_coffin_corners_ \int_value:w #2 _prop }
    \prop_gset_eq:cc { l_coffin_poles_ \int_value:w #1 _prop }
      { l_coffin_poles_ \int_value:w #2 _prop }
  }
\cs_new_protected:Npn \coffin_set_user_dimensions:N #1
  {
    \cs_set_eq:NN \coffin_saved_Height:      \Height
    \cs_set_eq:NN \coffin_saved_Depth:       \Depth
    \cs_set_eq:NN \coffin_saved_TotalHeight: \TotalHeight
    \cs_set_eq:NN \coffin_saved_Width:       \Width
    \cs_set_eq:NN \Height      \l_coffin_Height_dim
    \cs_set_eq:NN \Depth       \l_coffin_Depth_dim
    \cs_set_eq:NN \TotalHeight \l_coffin_TotalHeight_dim
    \cs_set_eq:NN \Width       \l_coffin_Width_dim
    \dim_set:Nn \Height      { \box_ht:N #1 }
    \dim_set:Nn \Depth       { \box_dp:N #1 }
    \dim_set:Nn \TotalHeight { \box_ht:N #1 + \box_dp:N #1 }
    \dim_set:Nn \Width       { \box_wd:N #1 }
  }
\cs_new_protected_nopar:Npn \coffin_end_user_dimensions:
  {
    \cs_set_eq:NN \Height      \coffin_saved_Height:
    \cs_set_eq:NN \Depth       \coffin_saved_Depth:
    \cs_set_eq:NN \TotalHeight \coffin_saved_TotalHeight:
    \cs_set_eq:NN \Width       \coffin_saved_Width:
  }
\cs_new_protected:Npn \coffin_set_horizontal_pole:Nnn #1#2#3
  {
    \coffin_if_exist:NT #1
      {
        \coffin_set_user_dimensions:N #1
        \coffin_set_pole:Nnx #1 {#2}
          {
            { 0 pt } { \dim_eval:n {#3} }
            { 1000 pt } { 0 pt }
          }
        \coffin_end_user_dimensions:
      }
  }
\cs_new_protected:Npn \coffin_set_vertical_pole:Nnn #1#2#3
  {
    \coffin_if_exist:NT #1
      {
        \coffin_set_user_dimensions:N #1
        \coffin_set_pole:Nnx #1 {#2}
          {
            { \dim_eval:n {#3} } { 0 pt }
            { 0 pt } { 1000 pt }
          }
        \coffin_end_user_dimensions:
      }
  }
\cs_new_protected:Npn \coffin_set_pole:Nnn #1#2#3
  { \prop_put:cnn { l_coffin_poles_ \int_value:w #1 _prop } {#2} {#3} }
\cs_generate_variant:Nn \coffin_set_horizontal_pole:Nnn { c }
\cs_generate_variant:Nn \coffin_set_vertical_pole:Nnn { c }
\cs_generate_variant:Nn \coffin_set_pole:Nnn { Nnx }
\cs_new_protected:Npn \coffin_update_corners:N #1
  {
    \prop_put:cnx { l_coffin_corners_ \int_value:w #1 _prop } { tl }
      { { 0 pt } { \dim_use:N \box_ht:N #1 } }
    \prop_put:cnx { l_coffin_corners_ \int_value:w #1 _prop } { tr }
      { { \dim_use:N \box_wd:N #1 } { \dim_use:N \box_ht:N #1 } }
    \prop_put:cnx { l_coffin_corners_ \int_value:w #1 _prop } { bl }
      { { 0 pt } { \dim_eval:n { - \box_dp:N #1 } } }
    \prop_put:cnx { l_coffin_corners_ \int_value:w #1 _prop } { br }
      { { \dim_use:N \box_wd:N #1 } { \dim_eval:n { - \box_dp:N #1 } } }
  }
\cs_new_protected:Npn \coffin_update_poles:N #1
  {
    \prop_put:cnx { l_coffin_poles_ \int_value:w #1 _prop } { hc }
      {
        { \dim_eval:n { 0.5 \box_wd:N #1 } }
        { 0 pt } { 0 pt } { 1000 pt }
      }
    \prop_put:cnx { l_coffin_poles_ \int_value:w #1 _prop } { r }
      {
        { \dim_use:N \box_wd:N #1 }
        { 0 pt } { 0 pt } { 1000 pt }
      }
    \prop_put:cnx { l_coffin_poles_ \int_value:w #1 _prop } { vc }
      {
        { 0 pt }
        { \dim_eval:n { ( \box_ht:N #1 - \box_dp:N #1 ) / 2 } }
        { 1000 pt }
        { 0 pt }
      }
    \prop_put:cnx { l_coffin_poles_ \int_value:w #1 _prop } { t }
      {
        { 0 pt }
        { \dim_use:N \box_ht:N #1 }
        { 1000 pt }
        { 0 pt }
      }
    \prop_put:cnx { l_coffin_poles_ \int_value:w #1 _prop } { b }
      {
        { 0 pt }
        { \dim_eval:n { - \box_dp:N #1 } }
        { 1000 pt }
        { 0 pt }
      }
  }
\cs_new_protected:Npn \coffin_calculate_intersection:Nnn #1#2#3
  {
    \coffin_get_pole:NnN #1 {#2} \l_coffin_pole_a_tl
    \coffin_get_pole:NnN #1 {#3} \l_coffin_pole_b_tl
    \bool_set_false:N \l_coffin_error_bool
    \exp_last_two_unbraced:Noo
      \coffin_calculate_intersection:nnnnnnnn
        \l_coffin_pole_a_tl \l_coffin_pole_b_tl
    \bool_if:NT \l_coffin_error_bool
      {
        \msg_kernel_error:nn { coffins } { no-pole-intersection }
        \dim_zero:N \l_coffin_x_dim
        \dim_zero:N \l_coffin_y_dim
      }
  }
\cs_new_protected:Npn \coffin_calculate_intersection:nnnnnnnn
  #1#2#3#4#5#6#7#8
  {
    \dim_compare:nNnTF {#3} = { \c_zero_dim }
      {
        \dim_set:Nn \l_coffin_x_dim {#1}
        \dim_compare:nNnTF {#7} = \c_zero_dim
          { \bool_set_true:N \l_coffin_error_bool }
          {
            \dim_compare:nNnTF {#8} = \c_zero_dim
              { \dim_set:Nn \l_coffin_y_dim {#6} }
              {
                \coffin_calculate_intersection_aux:nnnnnN
                  {#1} {#5} {#6} {#7} {#8} \l_coffin_y_dim
              }
          }
      }
      {
        \dim_compare:nNnTF {#4} = \c_zero_dim
          {
            \dim_set:Nn \l_coffin_y_dim {#2}
            \dim_compare:nNnTF {#8} = { \c_zero_dim }
              { \bool_set_true:N \l_coffin_error_bool }
              {
                \dim_compare:nNnTF {#7} = \c_zero_dim
                  { \dim_set:Nn \l_coffin_x_dim {#5} }
                  {
                    \coffin_calculate_intersection_aux:nnnnnN
                      {#2} {#6} {#5} {#8} {#7} \l_coffin_x_dim
                  }
              }
          }
          {
            \dim_compare:nNnTF {#7} = \c_zero_dim
              {
                \dim_set:Nn \l_coffin_x_dim {#5}
                \coffin_calculate_intersection_aux:nnnnnN
                  {#5} {#1} {#2} {#3} {#4} \l_coffin_y_dim
              }
              {
                \dim_compare:nNnTF {#8} = \c_zero_dim
                  {
                    \dim_set:Nn \l_coffin_x_dim {#6}
                    \coffin_calculate_intersection_aux:nnnnnN
                      {#6} {#2} {#1} {#4} {#3} \l_coffin_x_dim
                  }
                {
                    \fp_set_from_dim:Nn \l_coffin_calc_a_fp {#3}
                    \fp_set_from_dim:Nn \l_coffin_calc_b_fp {#4}
                    \fp_set_from_dim:Nn \l_coffin_calc_c_fp {#7}
                    \fp_set_from_dim:Nn \l_coffin_calc_d_fp {#8}
                    \fp_div:Nn \l_coffin_calc_b_fp \l_coffin_calc_a_fp
                    \fp_div:Nn \l_coffin_calc_d_fp \l_coffin_calc_c_fp
                    \fp_compare:nNnTF
                      \l_coffin_calc_b_fp = \l_coffin_calc_d_fp
                      { \bool_set_true:N \l_coffin_error_bool }
                      {
                        \fp_set_from_dim:Nn \l_coffin_calc_result_fp {#6}
                        \fp_set_from_dim:Nn \l_coffin_calc_a_fp {#2}
                        \fp_sub:Nn \l_coffin_calc_result_fp
                          { \l_coffin_calc_a_fp }
                        \fp_set_from_dim:Nn \l_coffin_calc_a_fp {#1}
                        \fp_mul:Nn \l_coffin_calc_a_fp
                          { \l_coffin_calc_b_fp }
                        \fp_add:Nn \l_coffin_calc_result_fp
                          { \l_coffin_calc_a_fp }
                        \fp_set_from_dim:Nn \l_coffin_calc_a_fp {#5}
                        \fp_mul:Nn \l_coffin_calc_a_fp
                          { \l_coffin_calc_d_fp }
                        \fp_sub:Nn \l_coffin_calc_result_fp
                          { \l_coffin_calc_a_fp }
                        \fp_sub:Nn \l_coffin_calc_b_fp
                          { \l_coffin_calc_d_fp }
                        \fp_div:Nn \l_coffin_calc_result_fp
                          { \l_coffin_calc_b_fp }
                        \dim_set:Nn \l_coffin_x_dim
                          { \fp_to_dim:N \l_coffin_calc_result_fp }
                        \coffin_calculate_intersection_aux:nnnnnN
                          { \l_coffin_x_dim }
                          {#5} {#6} {#8} {#7} \l_coffin_y_dim
                      }
                  }
              }
          }
      }
  }
\cs_new_protected:Npn \coffin_calculate_intersection_aux:nnnnnN
  #1#2#3#4#5#6
  {
    \fp_set_from_dim:Nn \l_coffin_calc_result_fp {#1}
    \fp_set_from_dim:Nn \l_coffin_calc_a_fp {#2}
    \fp_set_from_dim:Nn \l_coffin_calc_b_fp {#3}
    \fp_set_from_dim:Nn \l_coffin_calc_c_fp {#4}
    \fp_set_from_dim:Nn \l_coffin_calc_d_fp {#5}
    \fp_sub:Nn \l_coffin_calc_result_fp { \l_coffin_calc_a_fp }
    \fp_div:Nn \l_coffin_calc_result_fp { \l_coffin_calc_d_fp }
    \fp_mul:Nn \l_coffin_calc_result_fp { \l_coffin_calc_c_fp }
    \fp_add:Nn \l_coffin_calc_result_fp { \l_coffin_calc_b_fp }
    \dim_set:Nn #6 { \fp_to_dim:N \l_coffin_calc_result_fp }
  }
\cs_new_protected:Npn \coffin_join:NnnNnnnn #1#2#3#4#5#6#7#8
  {
    \coffin_align:NnnNnnnnN
      #1 {#2} {#3} #4 {#5} {#6} {#7} {#8} \l_coffin_aligned_coffin
    \hbox_set:Nn \l_coffin_aligned_coffin
      {
        \dim_compare:nNnT { \l_coffin_offset_x_dim } < \c_zero_dim
          { \tex_kern:D -\l_coffin_offset_x_dim }
        \hbox_unpack:N \l_coffin_aligned_coffin
        \dim_set:Nn \l_coffin_internal_dim
          { \l_coffin_offset_x_dim - \box_wd:N #1 + \box_wd:N #4 }
        \dim_compare:nNnT \l_coffin_internal_dim < \c_zero_dim
          { \tex_kern:D -\l_coffin_internal_dim }
      }
   \coffin_reset_structure:N \l_coffin_aligned_coffin
    \prop_clear:c
      {  l_coffin_corners_ \int_value:w \l_coffin_aligned_coffin _ prop }
    \coffin_update_poles:N \l_coffin_aligned_coffin
    \dim_compare:nNnTF \l_coffin_offset_x_dim < \c_zero_dim
      {
        \coffin_offset_poles:Nnn #1 { -\l_coffin_offset_x_dim } { 0 pt }
        \coffin_offset_poles:Nnn #4 { 0 pt } { \l_coffin_offset_y_dim }
        \coffin_offset_corners:Nnn #1 { -\l_coffin_offset_x_dim } { 0 pt }
        \coffin_offset_corners:Nnn #4 { 0 pt } { \l_coffin_offset_y_dim }
      }
      {
        \coffin_offset_poles:Nnn #1 { 0 pt } { 0 pt }
        \coffin_offset_poles:Nnn #4
          { \l_coffin_offset_x_dim } { \l_coffin_offset_y_dim }
        \coffin_offset_corners:Nnn #1 { 0 pt } { 0 pt }
        \coffin_offset_corners:Nnn #4
          { \l_coffin_offset_x_dim } { \l_coffin_offset_y_dim }
      }
    \coffin_update_vertical_poles:NNN #1 #4 \l_coffin_aligned_coffin
    \coffin_set_eq:NN #1 \l_coffin_aligned_coffin
  }
\cs_generate_variant:Nn \coffin_join:NnnNnnnn { c , Nnnc , cnnc }
\cs_new_protected:Npn \coffin_attach:NnnNnnnn #1#2#3#4#5#6#7#8
  {
    \coffin_align:NnnNnnnnN
      #1 {#2} {#3} #4 {#5} {#6} {#7} {#8} \l_coffin_aligned_coffin
    \box_set_ht:Nn \l_coffin_aligned_coffin { \box_ht:N #1 }
    \box_set_dp:Nn \l_coffin_aligned_coffin { \box_dp:N #1 }
    \box_set_wd:Nn \l_coffin_aligned_coffin { \box_wd:N #1 }
    \coffin_reset_structure:N \l_coffin_aligned_coffin
    \prop_set_eq:cc
      { l_coffin_corners_ \int_value:w \l_coffin_aligned_coffin _prop }
      { l_coffin_corners_ \int_value:w #1 _prop }
    \coffin_update_poles:N  \l_coffin_aligned_coffin
    \coffin_offset_poles:Nnn #1 { 0 pt } { 0 pt }
    \coffin_offset_poles:Nnn #4
      { \l_coffin_offset_x_dim } { \l_coffin_offset_y_dim }
    \coffin_update_vertical_poles:NNN #1 #4 \l_coffin_aligned_coffin
    \coffin_set_eq:NN #1 \l_coffin_aligned_coffin
  }
\cs_new_protected:Npn \coffin_attach_mark:NnnNnnnn #1#2#3#4#5#6#7#8
  {
    \coffin_align:NnnNnnnnN
      #1 {#2} {#3} #4 {#5} {#6} {#7} {#8} \l_coffin_aligned_coffin
    \box_set_ht:Nn \l_coffin_aligned_coffin { \box_ht:N #1 }
    \box_set_dp:Nn \l_coffin_aligned_coffin { \box_dp:N #1 }
    \box_set_wd:Nn \l_coffin_aligned_coffin { \box_wd:N #1 }
    \box_set_eq:NN #1 \l_coffin_aligned_coffin
  }
\cs_generate_variant:Nn \coffin_attach:NnnNnnnn { c , Nnnc , cnnc }
\cs_new_protected:Npn \coffin_align:NnnNnnnnN #1#2#3#4#5#6#7#8#9
  {
    \coffin_calculate_intersection:Nnn #4 {#5} {#6}
    \dim_set:Nn \l_coffin_x_prime_dim { \l_coffin_x_dim }
    \dim_set:Nn \l_coffin_y_prime_dim { \l_coffin_y_dim }
    \coffin_calculate_intersection:Nnn #1 {#2} {#3}
    \dim_set:Nn \l_coffin_offset_x_dim
      { \l_coffin_x_dim - \l_coffin_x_prime_dim + #7 }
    \dim_set:Nn \l_coffin_offset_y_dim
      { \l_coffin_y_dim - \l_coffin_y_prime_dim + #8 }
    \hbox_set:Nn \l_coffin_aligned_internal_coffin
      {
        \box_use:N #1
        \tex_kern:D -\box_wd:N #1
        \tex_kern:D \l_coffin_offset_x_dim
        \box_move_up:nn { \l_coffin_offset_y_dim } { \box_use:N #4 }
      }
    \coffin_set_eq:NN #9 \l_coffin_aligned_internal_coffin
  }
\cs_new_protected:Npn \coffin_offset_poles:Nnn #1#2#3
  {
    \prop_map_inline:cn { l_coffin_poles_ \int_value:w #1 _prop }
      { \coffin_offset_pole:Nnnnnnn #1 {##1} ##2 {#2} {#3} }
  }
\cs_new_protected:Npn \coffin_offset_pole:Nnnnnnn #1#2#3#4#5#6#7#8
  {
    \dim_set:Nn \l_coffin_x_dim { #3 + #7 }
    \dim_set:Nn \l_coffin_y_dim { #4 + #8 }
    \tl_if_in:nnTF {#2} { - }
      { \tl_set:Nn \l_coffin_internal_tl { {#2} } }
      { \tl_set:Nn \l_coffin_internal_tl { { #1 - #2 } } }
    \exp_last_unbraced:NNo \coffin_set_pole:Nnx \l_coffin_aligned_coffin
      { \l_coffin_internal_tl }
      {
        { \dim_use:N \l_coffin_x_dim } { \dim_use:N \l_coffin_y_dim }
        {#5} {#6}
      }
  }
\cs_new_protected:Npn \coffin_offset_corners:Nnn #1#2#3
  {
    \prop_map_inline:cn { l_coffin_corners_ \int_value:w #1 _prop }
      { \coffin_offset_corner:Nnnnn #1 {##1} ##2 {#2} {#3} }
  }
\cs_new_protected:Npn \coffin_offset_corner:Nnnnn #1#2#3#4#5#6
  {
    \prop_put:cnx
      { l_coffin_corners_ \int_value:w \l_coffin_aligned_coffin _prop }
      { #1 - #2 }
      {
        { \dim_eval:n { #3 + #5 } }
        { \dim_eval:n { #4 + #6 } }
      }
  }
\cs_new_protected:Npn \coffin_update_vertical_poles:NNN #1#2#3
  {
    \coffin_get_pole:NnN #3 { #1 -T } \l_coffin_pole_a_tl
    \coffin_get_pole:NnN #3 { #2 -T } \l_coffin_pole_b_tl
    \exp_last_two_unbraced:Noo \coffin_update_T:nnnnnnnnN
      \l_coffin_pole_a_tl \l_coffin_pole_b_tl #3
    \coffin_get_pole:NnN #3 { #1 -B } \l_coffin_pole_a_tl
    \coffin_get_pole:NnN #3 { #2 -B } \l_coffin_pole_b_tl
    \exp_last_two_unbraced:Noo \coffin_update_B:nnnnnnnnN
      \l_coffin_pole_a_tl \l_coffin_pole_b_tl #3
  }
\cs_new_protected:Npn \coffin_update_T:nnnnnnnnN #1#2#3#4#5#6#7#8#9
  {
    \dim_compare:nNnTF {#2} < {#6}
      {
        \coffin_set_pole:Nnx #9 { T }
          { { 0 pt } {#6} { 1000 pt } { 0 pt } }
      }
      {
        \coffin_set_pole:Nnx #9 { T }
          { { 0 pt } {#2} { 1000 pt } { 0 pt } }
      }
  }
\cs_new_protected:Npn \coffin_update_B:nnnnnnnnN #1#2#3#4#5#6#7#8#9
  {
    \dim_compare:nNnTF {#2} < {#6}
      {
        \coffin_set_pole:Nnx #9 { B }
          { { 0 pt } {#2}  { 1000 pt } { 0 pt } }
      }
      {
        \coffin_set_pole:Nnx #9 { B }
          { { 0 pt } {#6} { 1000 pt } { 0 pt } }
      }
  }
\cs_new_protected:Npn \coffin_typeset:Nnnnn #1#2#3#4#5
  {
    \coffin_align:NnnNnnnnN \c_empty_coffin { H } { l }
      #1 {#2} {#3} {#4} {#5} \l_coffin_aligned_coffin
    \hbox_unpack:N \c_empty_box
    \box_use:N \l_coffin_aligned_coffin
  }
\cs_generate_variant:Nn \coffin_typeset:Nnnnn { c }
\prop_new:N \l_coffin_bounding_prop
\dim_new:N \l_coffin_bounding_shift_dim
\dim_new:N \l_coffin_left_corner_dim
\dim_new:N \l_coffin_right_corner_dim
\dim_new:N \l_coffin_bottom_corner_dim
\dim_new:N \l_coffin_top_corner_dim
\cs_new_protected:Npn \coffin_rotate:Nn #1#2
  {
    \fp_set:Nn \l_coffin_internal_fp {#2}
    \fp_div:Nn \l_coffin_internal_fp { 180 }
    \fp_mul:Nn \l_coffin_internal_fp { \c_pi_fp }
    \fp_sin:Nn \l_coffin_sin_fp { \l_coffin_internal_fp }
    \fp_cos:Nn \l_coffin_cos_fp { \l_coffin_internal_fp }
    \prop_map_inline:cn { l_coffin_corners_ \int_value:w #1 _prop }
      { \coffin_rotate_corner:Nnnn #1 {##1} ##2 }
    \prop_map_inline:cn { l_coffin_poles_ \int_value:w #1 _prop }
      { \coffin_rotate_pole:Nnnnnn #1 {##1} ##2 }
    \coffin_set_bounding:N #1
    \prop_map_inline:Nn \l_coffin_bounding_prop
      { \coffin_rotate_bounding:nnn {##1} ##2 }
    \coffin_find_corner_maxima:N #1
    \coffin_find_bounding_shift:
    \box_rotate:Nn #1 {#2}
    \hbox_set:Nn #1
      {
        \tex_kern:D \l_coffin_bounding_shift_dim
        \tex_kern:D -\l_coffin_left_corner_dim
        \box_move_down:nn { \l_coffin_bottom_corner_dim }
          { \box_use:N #1 }
      }
    \box_set_ht:Nn #1
      { \l_coffin_top_corner_dim - \l_coffin_bottom_corner_dim }
    \box_set_dp:Nn #1 { 0 pt }
    \box_set_wd:Nn #1
      { \l_coffin_right_corner_dim - \l_coffin_left_corner_dim }
    \prop_map_inline:cn { l_coffin_corners_ \int_value:w #1 _prop }
      { \coffin_shift_corner:Nnnn #1 {##1} ##2 }
    \prop_map_inline:cn { l_coffin_poles_ \int_value:w #1 _prop }
      { \coffin_shift_pole:Nnnnnn #1 {##1} ##2 }
  }
\cs_generate_variant:Nn \coffin_rotate:Nn { c }
\cs_new_protected:Npn \coffin_set_bounding:N #1
  {
   \prop_put:Nnx \l_coffin_bounding_prop { tl }
      { { 0 pt } { \dim_use:N \box_ht:N #1 } }
    \prop_put:Nnx \l_coffin_bounding_prop { tr }
      { { \dim_use:N \box_wd:N #1 } { \dim_use:N \box_ht:N #1 } }
    \dim_set:Nn \l_coffin_internal_dim { - \box_dp:N #1 }
    \prop_put:Nnx \l_coffin_bounding_prop { bl }
      { { 0 pt } { \dim_use:N \l_coffin_internal_dim } }
    \prop_put:Nnx \l_coffin_bounding_prop { br }
      { { \dim_use:N \box_wd:N #1 } { \dim_use:N \l_coffin_internal_dim } }
  }
\cs_new_protected:Npn \coffin_rotate_bounding:nnn #1#2#3
  {
    \coffin_rotate_vector:nnNN {#2} {#3} \l_coffin_x_dim \l_coffin_y_dim
    \prop_put:Nnx \l_coffin_bounding_prop {#1}
      { { \dim_use:N \l_coffin_x_dim } { \dim_use:N \l_coffin_y_dim } }
  }
\cs_new_protected:Npn \coffin_rotate_corner:Nnnn #1#2#3#4
  {
    \coffin_rotate_vector:nnNN {#3} {#4} \l_coffin_x_dim \l_coffin_y_dim
    \prop_put:cnx { l_coffin_corners_ \int_value:w #1 _prop } {#2}
      { { \dim_use:N \l_coffin_x_dim } { \dim_use:N \l_coffin_y_dim } }
  }
\cs_new_protected:Npn \coffin_rotate_pole:Nnnnnn #1#2#3#4#5#6
  {
    \coffin_rotate_vector:nnNN {#3} {#4} \l_coffin_x_dim \l_coffin_y_dim
    \coffin_rotate_vector:nnNN {#5} {#6}
      \l_coffin_x_prime_dim \l_coffin_y_prime_dim
    \coffin_set_pole:Nnx #1 {#2}
      {
        { \dim_use:N \l_coffin_x_dim } { \dim_use:N \l_coffin_y_dim }
        { \dim_use:N \l_coffin_x_prime_dim }
        { \dim_use:N \l_coffin_y_prime_dim }
      }
  }
\cs_new_protected:Npn \coffin_rotate_vector:nnNN #1#2#3#4
  {
    \fp_set_from_dim:Nn \l_coffin_x_fp {#1}
    \fp_set_from_dim:Nn \l_coffin_y_fp {#2}
    \fp_set_eq:NN \l_coffin_x_prime_fp \l_coffin_x_fp
    \fp_set_eq:NN \l_coffin_internal_fp     \l_coffin_y_fp
    \fp_mul:Nn \l_coffin_x_prime_fp { \l_coffin_cos_fp }
    \fp_mul:Nn \l_coffin_internal_fp     { \l_coffin_sin_fp }
    \fp_sub:Nn \l_coffin_x_prime_fp { \l_coffin_internal_fp }
    \fp_set_eq:NN \l_coffin_y_prime_fp \l_coffin_y_fp
    \fp_set_eq:NN \l_coffin_internal_fp     \l_coffin_x_fp
    \fp_mul:Nn \l_coffin_y_prime_fp { \l_coffin_cos_fp }
    \fp_mul:Nn \l_coffin_internal_fp     { \l_coffin_sin_fp }
    \fp_add:Nn \l_coffin_y_prime_fp { \l_coffin_internal_fp }
    \dim_set:Nn #3 { \fp_to_dim:N \l_coffin_x_prime_fp }
    \dim_set:Nn #4 { \fp_to_dim:N \l_coffin_y_prime_fp }
  }
\cs_new_protected:Npn \coffin_find_corner_maxima:N #1
  {
    \dim_set:Nn \l_coffin_top_corner_dim   { -\c_max_dim }
    \dim_set:Nn \l_coffin_right_corner_dim { -\c_max_dim }
    \dim_set:Nn \l_coffin_bottom_corner_dim { \c_max_dim }
    \dim_set:Nn \l_coffin_left_corner_dim   { \c_max_dim }
    \prop_map_inline:cn { l_coffin_corners_ \int_value:w #1 _prop }
      { \coffin_find_corner_maxima_aux:nn ##2 }
  }
\cs_new_protected:Npn \coffin_find_corner_maxima_aux:nn #1#2
  {
    \dim_set_min:Nn \l_coffin_left_corner_dim   {#1}
    \dim_set_max:Nn \l_coffin_right_corner_dim  {#1}
    \dim_set_min:Nn \l_coffin_bottom_corner_dim {#2}
    \dim_set_max:Nn \l_coffin_top_corner_dim    {#2}
  }
\cs_new_protected_nopar:Npn \coffin_find_bounding_shift:
  {
    \dim_set:Nn \l_coffin_bounding_shift_dim { \c_max_dim }
    \prop_map_inline:Nn \l_coffin_bounding_prop
      { \coffin_find_bounding_shift_aux:nn ##2 }
  }
\cs_new_protected:Npn \coffin_find_bounding_shift_aux:nn #1#2
  { \dim_set_min:Nn \l_coffin_bounding_shift_dim {#1} }
\cs_new_protected:Npn \coffin_shift_corner:Nnnn #1#2#3#4
  {
    \prop_put:cnx { l_coffin_corners_ \int_value:w #1 _ prop } {#2}
      {
        { \dim_eval:n { #3 - \l_coffin_left_corner_dim } }
        { \dim_eval:n { #4 - \l_coffin_bottom_corner_dim } }
      }
  }
\cs_new_protected:Npn \coffin_shift_pole:Nnnnnn #1#2#3#4#5#6
  {
    \prop_put:cnx { l_coffin_poles_ \int_value:w #1 _ prop } {#2}
      {
        { \dim_eval:n { #3 - \l_coffin_left_corner_dim } }
        { \dim_eval:n { #4 - \l_coffin_bottom_corner_dim } }
        {#5} {#6}
      }
  }
\fp_new:N \l_coffin_scale_x_fp
\fp_new:N \l_coffin_scale_y_fp
\dim_new:N \l_coffin_scaled_total_height_dim
\dim_new:N \l_coffin_scaled_width_dim
\cs_new_protected:Npn \coffin_resize:Nnn #1#2#3
  {
    \coffin_set_user_dimensions:N #1
    \box_resize:Nnn #1 {#2} {#3}
    \fp_set_from_dim:Nn \l_coffin_scale_x_fp {#2}
    \fp_set_from_dim:Nn \l_coffin_internal_fp { \Width }
    \fp_div:Nn \l_coffin_scale_x_fp { \l_coffin_internal_fp }
    \fp_set_from_dim:Nn \l_coffin_scale_y_fp {#3}
    \fp_set_from_dim:Nn \l_coffin_internal_fp { \TotalHeight }
    \fp_div:Nn \l_coffin_scale_y_fp { \l_coffin_internal_fp }
    \coffin_resize_common:Nnn #1 {#2} {#3}
  }
\cs_generate_variant:Nn \coffin_resize:Nnn { c }
\cs_new_protected:Npn \coffin_resize_common:Nnn #1#2#3
  {
    \prop_map_inline:cn { l_coffin_corners_ \int_value:w #1 _prop }
      { \coffin_scale_corner:Nnnn #1 {##1} ##2 }
    \prop_map_inline:cn { l_coffin_poles_ \int_value:w #1 _prop }
      { \coffin_scale_pole:Nnnnnn #1 {##1} ##2 }
    \fp_compare:NNNT \l_coffin_scale_x_fp < \c_zero_fp
      {
        \prop_map_inline:cn { l_coffin_corners_ \int_value:w #1 _prop }
          { \coffin_x_shift_corner:Nnnn #1 {##1} ##2 }
        \prop_map_inline:cn { l_coffin_poles_ \int_value:w #1 _prop }
          { \coffin_x_shift_pole:Nnnnnn #1 {##1} ##2 }
      }
    \coffin_end_user_dimensions:
  }
\cs_new_protected:Npn \coffin_scale:Nnn #1#2#3
  {
    \box_scale:Nnn #1 {#2} {#3}
    \coffin_set_user_dimensions:N #1
    \fp_set:Nn \l_coffin_scale_x_fp {#2}
    \fp_set:Nn \l_coffin_scale_y_fp {#3}
    \fp_compare:NNNTF \l_coffin_scale_y_fp > \c_zero_fp
      { \l_coffin_scaled_total_height_dim #3 \TotalHeight }
      { \l_coffin_scaled_total_height_dim -#3 \TotalHeight }
    \fp_compare:NNNTF \l_coffin_scale_x_fp > \c_zero_fp
      { \l_coffin_scaled_width_dim -#2 \Width }
      { \l_coffin_scaled_width_dim #2 \Width }
    \coffin_resize_common:Nnn #1
      { \l_coffin_scaled_width_dim } { \l_coffin_scaled_total_height_dim }
  }
\cs_generate_variant:Nn \coffin_scale:Nnn { c }
\cs_new_protected:Npn \coffin_scale_vector:nnNN #1#2#3#4
  {
    \fp_set_from_dim:Nn \l_coffin_internal_fp {#1}
    \fp_mul:Nn \l_coffin_internal_fp { \l_coffin_scale_x_fp }
    \dim_set:Nn #3 { \fp_to_dim:N \l_coffin_internal_fp }
    \fp_set_from_dim:Nn \l_coffin_internal_fp {#2}
    \fp_mul:Nn \l_coffin_internal_fp { \l_coffin_scale_y_fp }
    \dim_set:Nn #4 { \fp_to_dim:N \l_coffin_internal_fp }
  }
\cs_new_protected:Npn \coffin_scale_corner:Nnnn #1#2#3#4
  {
    \coffin_scale_vector:nnNN {#3} {#4} \l_coffin_x_dim \l_coffin_y_dim
    \prop_put:cnx { l_coffin_corners_ \int_value:w #1 _prop } {#2}
      { { \dim_use:N \l_coffin_x_dim } { \dim_use:N \l_coffin_y_dim } }
  }
\cs_new_protected:Npn \coffin_scale_pole:Nnnnnn #1#2#3#4#5#6
  {
    \coffin_scale_vector:nnNN {#3} {#4} \l_coffin_x_dim \l_coffin_y_dim
    \coffin_set_pole:Nnx #1 {#2}
      {
        { \dim_use:N \l_coffin_x_dim } { \dim_use:N \l_coffin_y_dim }
        {#5} {#6}
      }
  }
\cs_new_protected:Npn \coffin_x_shift_corner:Nnnn #1#2#3#4
  {
    \prop_put:cnx { l_coffin_corners_ \int_value:w #1 _prop } {#2}
      {
        { \dim_eval:n { #3 + \box_wd:N #1 } } {#4}
    }
  }
\cs_new_protected:Npn \coffin_x_shift_pole:Nnnnnn #1#2#3#4#5#6
  {
    \prop_put:cnx { l_coffin_poles_ \int_value:w #1 _prop } {#2}
      {
        { \dim_eval:n #3 + \box_wd:N #1 } {#4}
        {#5} {#6}
      }
  }
\coffin_new:N \l_coffin_display_coffin
\coffin_new:N \l_coffin_display_coord_coffin
\coffin_new:N \l_coffin_display_pole_coffin
\prop_new:N \l_coffin_display_handles_prop
\prop_put:Nnn \l_coffin_display_handles_prop { tl }
  { { b } { r } { -1 } { 1 } }
\prop_put:Nnn \l_coffin_display_handles_prop { thc }
  { { b } { hc } { 0 } { 1 } }
\prop_put:Nnn \l_coffin_display_handles_prop { tr }
  { { b } { l } { 1 } { 1 } }
\prop_put:Nnn \l_coffin_display_handles_prop { vcl }
  { { vc } { r } { -1 } { 0 } }
\prop_put:Nnn \l_coffin_display_handles_prop { vchc }
  { { vc } { hc } { 0 } { 0 } }
\prop_put:Nnn \l_coffin_display_handles_prop { vcr }
  { { vc } { l } { 1 } { 0 } }
\prop_put:Nnn \l_coffin_display_handles_prop { bl }
  { { t } { r } { -1 } { -1 } }
\prop_put:Nnn \l_coffin_display_handles_prop { bhc }
  { { t } { hc } { 0 } { -1 } }
\prop_put:Nnn \l_coffin_display_handles_prop { br }
  { { t } { l } { 1 } { -1 } }
\prop_put:Nnn \l_coffin_display_handles_prop { Tl }
  { { t } { r } { -1 } { -1 } }
\prop_put:Nnn \l_coffin_display_handles_prop { Thc }
  { { t } { hc } { 0 } { -1 } }
\prop_put:Nnn \l_coffin_display_handles_prop { Tr }
  { { t } { l } { 1 } { -1 } }
\prop_put:Nnn \l_coffin_display_handles_prop { Hl }
  { { vc } { r } { -1 } { 1 } }
\prop_put:Nnn \l_coffin_display_handles_prop { Hhc }
  { { vc } { hc } { 0 } { 1 } }
\prop_put:Nnn \l_coffin_display_handles_prop { Hr }
  { { vc } { l } { 1 } { 1 } }
\prop_put:Nnn \l_coffin_display_handles_prop { Bl }
  { { b } { r } { -1 } { -1 } }
\prop_put:Nnn \l_coffin_display_handles_prop { Bhc }
  { { b } { hc } { 0 } { -1 } }
\prop_put:Nnn \l_coffin_display_handles_prop { Br }
  { { b } { l } { 1 } { -1 } }
\dim_new:N  \l_coffin_display_offset_dim
\dim_set:Nn \l_coffin_display_offset_dim { 2 pt }
\dim_new:N \l_coffin_display_x_dim
\dim_new:N \l_coffin_display_y_dim
\prop_new:N \l_coffin_display_poles_prop
\tl_new:N  \l_coffin_display_font_tl
\tl_set:Nn \l_coffin_display_font_tl { \sffamily \tiny }
\cs_new_protected:Npn \coffin_mark_handle:Nnnn #1#2#3#4
  {
    \hcoffin_set:Nn \l_coffin_display_pole_coffin
      {
        \color {#4}
        \rule { 1 pt } { 1 pt }
      }
    \coffin_attach_mark:NnnNnnnn #1 {#2} {#3}
      \l_coffin_display_pole_coffin { hc } { vc } { 0 pt } { 0 pt }
    \hcoffin_set:Nn \l_coffin_display_coord_coffin
      {
        \color {#4}
        \l_coffin_display_font_tl
        ( \tl_to_str:n { #2 , #3 } )
      }
    \prop_get:NnN \l_coffin_display_handles_prop
      { #2 #3 } \l_coffin_internal_tl
    \quark_if_no_value:NTF \l_coffin_internal_tl
      {
        \prop_get:NnN \l_coffin_display_handles_prop
          { #3 #2 } \l_coffin_internal_tl
        \quark_if_no_value:NTF \l_coffin_internal_tl
          {
            \coffin_attach_mark:NnnNnnnn #1 {#2} {#3}
              \l_coffin_display_coord_coffin { l } { vc }
                { 1 pt } { 0 pt }
          }
          {
            \exp_last_unbraced:No \coffin_mark_handle_aux:nnnnNnn
              \l_coffin_internal_tl #1 {#2} {#3}
          }
      }
      {
        \exp_last_unbraced:No \coffin_mark_handle_aux:nnnnNnn
          \l_coffin_internal_tl #1 {#2} {#3}
      }
  }
\cs_new_protected:Npn \coffin_mark_handle_aux:nnnnNnn #1#2#3#4#5#6#7
  {
    \coffin_attach_mark:NnnNnnnn #5 {#6} {#7}
      \l_coffin_display_coord_coffin {#1} {#2}
      { #3 \l_coffin_display_offset_dim }
      { #4 \l_coffin_display_offset_dim }
  }
\cs_generate_variant:Nn \coffin_mark_handle:Nnnn { c }
\cs_new_protected:Npn \coffin_display_handles:Nn #1#2
  {
    \hcoffin_set:Nn \l_coffin_display_pole_coffin
      {
        \color {#2}
        \rule { 1 pt } { 1 pt }
      }
    \prop_set_eq:Nc \l_coffin_display_poles_prop
      { l_coffin_poles_ \int_value:w #1 _prop }
    \coffin_get_pole:NnN #1 { H } \l_coffin_pole_a_tl
    \coffin_get_pole:NnN #1 { T } \l_coffin_pole_b_tl
    \tl_if_eq:NNT \l_coffin_pole_a_tl \l_coffin_pole_b_tl
      { \prop_del:Nn \l_coffin_display_poles_prop { T } }
    \coffin_get_pole:NnN #1 { B } \l_coffin_pole_b_tl
    \tl_if_eq:NNT \l_coffin_pole_a_tl \l_coffin_pole_b_tl
      { \prop_del:Nn \l_coffin_display_poles_prop { B } }
    \coffin_set_eq:NN \l_coffin_display_coffin #1
    \prop_map_inline:Nn \l_coffin_display_poles_prop
      {
        \prop_del:Nn \l_coffin_display_poles_prop {##1}
        \coffin_display_handles_aux:nnnnnn {##1} ##2 {#2}
      }
    \box_use:N \l_coffin_display_coffin
  }
\cs_new_protected:Npn \coffin_display_handles_aux:nnnnnn #1#2#3#4#5#6
  {
    \prop_map_inline:Nn \l_coffin_display_poles_prop
      {
        \bool_set_false:N \l_coffin_error_bool
        \coffin_calculate_intersection:nnnnnnnn {#2} {#3} {#4} {#5} ##2
        \bool_if:NF \l_coffin_error_bool
          {
            \dim_set:Nn \l_coffin_display_x_dim { \l_coffin_x_dim }
            \dim_set:Nn \l_coffin_display_y_dim { \l_coffin_y_dim }
            \coffin_display_attach:Nnnnn
              \l_coffin_display_pole_coffin { hc } { vc }
              { 0 pt } { 0 pt }
            \hcoffin_set:Nn \l_coffin_display_coord_coffin
              {
                \color {#6}
                \l_coffin_display_font_tl
                ( \tl_to_str:n { #1 , ##1 } )
              }
            \prop_get:NnN \l_coffin_display_handles_prop
              { #1 ##1 } \l_coffin_internal_tl
            \quark_if_no_value:NTF \l_coffin_internal_tl
              {
                \prop_get:NnN \l_coffin_display_handles_prop
                  { ##1 #1 } \l_coffin_internal_tl
                \quark_if_no_value:NTF \l_coffin_internal_tl
                  {
                    \coffin_display_attach:Nnnnn
                      \l_coffin_display_coord_coffin { l } { vc }
                      { 1 pt } { 0 pt }
                  }
                  {
                    \exp_last_unbraced:No
                      \coffin_display_handles_aux:nnnn
                      \l_coffin_internal_tl
                  }
              }
              {
                \exp_last_unbraced:No \coffin_display_handles_aux:nnnn
                  \l_coffin_internal_tl
              }
          }
      }
  }
\cs_new_protected:Npn \coffin_display_handles_aux:nnnn #1#2#3#4
  {
    \coffin_display_attach:Nnnnn
      \l_coffin_display_coord_coffin {#1} {#2}
      { #3 \l_coffin_display_offset_dim }
      { #4 \l_coffin_display_offset_dim }
  }
\cs_generate_variant:Nn \coffin_display_handles:Nn { c }
\cs_new_protected:Npn \coffin_display_attach:Nnnnn #1#2#3#4#5
  {
    \coffin_calculate_intersection:Nnn #1 {#2} {#3}
    \dim_set:Nn \l_coffin_x_prime_dim { \l_coffin_x_dim }
    \dim_set:Nn \l_coffin_y_prime_dim { \l_coffin_y_dim }
    \dim_set:Nn \l_coffin_offset_x_dim
      { \l_coffin_display_x_dim - \l_coffin_x_prime_dim + #4 }
    \dim_set:Nn \l_coffin_offset_y_dim
      { \l_coffin_display_y_dim - \l_coffin_y_prime_dim + #5 }
    \hbox_set:Nn \l_coffin_aligned_coffin
      {
        \box_use:N \l_coffin_display_coffin
        \tex_kern:D -\box_wd:N \l_coffin_display_coffin
        \tex_kern:D \l_coffin_offset_x_dim
        \box_move_up:nn { \l_coffin_offset_y_dim } { \box_use:N #1 }
      }
    \box_set_ht:Nn \l_coffin_aligned_coffin
      { \box_ht:N \l_coffin_display_coffin }
    \box_set_dp:Nn \l_coffin_aligned_coffin
      { \box_dp:N \l_coffin_display_coffin }
    \box_set_wd:Nn \l_coffin_aligned_coffin
      { \box_wd:N \l_coffin_display_coffin }
    \box_set_eq:NN \l_coffin_display_coffin \l_coffin_aligned_coffin
  }
\cs_new_protected:Npn \coffin_show_structure:N #1
  {
    \coffin_if_exist:NT #1
      {
        \msg_aux_show:Nnx #1 { coffins }
          {
            \prop_map_function:cN
              { l_coffin_poles_ \int_value:w #1 _prop }
              \msg_aux_show_unbraced:nn
          }
      }
  }
\cs_generate_variant:Nn \coffin_show_structure:N { c }
\msg_kernel_new:nnnn { coffins } { no-pole-intersection }
  { No~intersection~between~coffin~poles. }
  {
    \c_msg_coding_error_text_tl
    LaTeX~was~asked~to~find~the~intersection~between~two~poles,~
    but~they~do~not~have~a~unique~meeting~point:~
    the~value~(0~pt,~0~pt)~will~be~used.
  }
\msg_kernel_new:nnnn { coffins } { unknown-coffin }
  { Unknown~coffin~'#1'. }
  { The~coffin~'#1'~was~never~defined. }
\msg_kernel_new:nnnn { coffins } { unknown-coffin-pole }
  { Pole~'#1'~unknown~for~coffin~'#2'. }
  {
    \c_msg_coding_error_text_tl
    LaTeX~was~asked~to~find~a~typesetting~pole~for~a~coffin,~
    but~either~the~coffin~does~not~exist~or~the~pole~name~is~wrong.
  }
\msg_kernel_new:nnn { coffins } { show }
  {
    Size~of~coffin~\token_to_str:N #1 : \\
    > ~ ht~=~\dim_use:N \box_ht:N #1 \\
    > ~ dp~=~\dim_use:N \box_dp:N #1 \\
    > ~ wd~=~\dim_use:N \box_wd:N #1 \\
    Poles~of~coffin~\token_to_str:N #1 :
  }
%% 
%%
%% End of file `l3coffins.sty'.
